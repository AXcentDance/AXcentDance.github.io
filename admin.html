<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | AXcent Dance</title>
    <link rel="stylesheet" href="style.css?v=mobilefix">
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            padding-top: 100px;
            background: #0f0518;
            color: white;
        }

        .admin-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 1rem;
        }

        .admin-nav button {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.1rem;
            cursor: pointer;
        }

        .admin-nav button.active {
            color: var(--accent-start);
            font-weight: bold;
        }

        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            color: var(--text-muted);
            font-weight: normal;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .status-expired {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .status-future {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
    </style>

  <!-- Cookie Consent -->
  <link rel="stylesheet" href="assets/css/cookie-consent.css">
  <script src="assets/js/cookie-consent.js" defer></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-E2SYCF7R7X"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-E2SYCF7R7X');
  </script>
  <!-- CRITICAL: FAIL-SAFE MOBILE MENU STYLES -->
  <style>
    /* DESKTOP (900px+) - HIDE BUTTON */
    @media (min-width: 900px) {
      .mobile-menu-btn {
        display: none !important;
      }
    }

    /* MOBILE (<900px) - SHOW BUTTON ABSOLUTE LEFT */
    @media (max-width: 899px) {
      .navbar {
        position: relative !important;
        /* Ensure anchor */
        justify-content: center !important;
        /* Center logo */
      }

      .mobile-menu-btn {
        display: flex !important;
        position: absolute !important;
        /* Absolute to navbar */
        top: 50% !important;
        transform: translateY(-50%) !important;
        left: 15px !important;
        z-index: 10001 !important;

        background: transparent !important;
        border: none !important;
        color: white !important;

        width: 44px;
        height: 44px;
        align-items: center;
        justify-content: center;
        padding: 0;
        cursor: pointer;
      }

      /* Ensure SVG is visible */
      .mobile-menu-btn svg {
        width: 30px !important;
        height: 30px !important;
        stroke: white !important;
        display: block !important;
      }
    }
  </style>
</head>

<body>
    <div class="container">
        <h1 style="margin-bottom: 0.5rem;">Admin Dashboard üîí</h1>
        <p id="adminUserDisplay" style="color: var(--text-muted); margin-bottom: 2rem;">Loading...</p>

        <div class="admin-nav">
            <button class="active" onclick="switchTab('live')">Live Check-ins</button>
            <button onclick="switchTab('active-students')">Active Students</button>
            <button onclick="switchTab('all-students')">All History</button>
        </div>

        <!-- 1. LIVE CHECK-INS -->
        <div id="live" class="dashboard-section active">
            <div class="stat-card">
                <h3>Checked In Today</h3>
                <h1 id="checkInCount" style="font-size: 3rem; color: var(--accent-start);">0</h1>
            </div>

            <h3>Recent Activity</h3>
            <table id="liveTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Student</th>
                        <th>Class</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="liveTableBody">
                    <tr>
                        <td colspan="4" style="text-align: center; color: var(--text-muted);">Loading live data...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 2. ACTIVE STUDENTS (Filtered) -->
        <div id="active-students" class="dashboard-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Currently Active Passes</h3>
                <button onclick="window.print()"
                    style="background: rgba(255,255,255,0.1); border:none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Print
                    List</button>
            </div>
            <p style="color: var(--text-muted); font-size: 0.9rem;">
                Showing only students with passes valid TODAY (<span id="currentDate"></span>).
            </p>

            <table id="activeTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Package</th>
                        <th>Valid Until</th>
                        <th>Attended</th>
                    </tr>
                </thead>
                <tbody id="activeTableBody">
                    <!-- JS will populate -->
                </tbody>
            </table>
        </div>

        <!-- 3. ALL HISTORY -->
        <div id="all-students" class="dashboard-section">
            <h3>Full Student Database</h3>
            <table id="allTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Package</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="allTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { supabase } from './assets/js/supabase-client.js';

        // Set Current Date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString();

        // Check Admin Auth
        async function checkAdmin() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            if (user.email !== 'info@axcentdance.com') { // ‚ö†Ô∏è Hardcoded Security Check (Matches DB Policy)
                document.body.innerHTML = '<div class="container" style="padding-top:100px"><h1>Access Denied üö´</h1><p>You are not an authorized administrator.</p></div>';
                return;
            }
            document.getElementById('adminUserDisplay').textContent = `Logged in as: ${user.email}`;
            loadDashboardData();
        }

        async function loadDashboardData() {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

            // 1. Fetch Active Passes
            // Logic: start_date <= today AND end_date >= today
            const { data: activePasses, error: passError } = await supabase
                .from('user_passes')
                .select(`
                    *,
                    profiles:user_id (first_name, last_name, email)
                `)
                .lte('start_date', today)
                .gte('end_date', today);

            if (passError) console.error('Error fetching passes:', passError);
            else renderActiveStudents(activePasses);

            // 2. Fetch All Passes (For History Tab)
            const { data: allPasses } = await supabase
                .from('user_passes')
                .select(`*, profiles:user_id (first_name, last_name)`)
                .order('created_at', { ascending: false });

            if (allPasses) renderAllStudents(allPasses);


            // 3. Fetch Live Check-ins (Today)
            /* 
               Note: Since 'attendance_logs' isn't fully populated yet, 
               this is a placeholder implementation for the structure.
            */
            const { data: logs } = await supabase
                .from('attendance_logs')
                .select(`*, profiles:user_id (first_name, last_name)`)
                .order('check_in_time', { ascending: false })
                .limit(20);

            renderLiveLogs(logs || []);
        }

        function renderActiveStudents(passes) {
            const tbody = document.getElementById('activeTableBody');
            tbody.innerHTML = '';

            if (!passes || passes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem;">No active students found right now.</td></tr>';
                return;
            }

            passes.forEach(pass => {
                const row = document.createElement('tr');
                // Calculate days remaining
                const end = new Date(pass.end_date);
                const now = new Date();
                const diffTime = Math.abs(end - now);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                row.innerHTML = `
                    <td style="font-weight:bold;">${pass.profiles?.first_name || 'Unlinked'} ${pass.profiles?.last_name || ''}</td>
                    <td>${pass.package_name}</td>
                    <td>${pass.end_date} <br><span style="color:var(--text-muted); font-size:0.8em">(${diffDays} days left)</span></td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="markAttendance('${pass.user_id}', '${pass.id}', '${pass.package_name}', 'present')" 
                                style="background:rgba(46, 204, 113, 0.2); color:#2ecc71; border:1px solid #2ecc71; border-radius:4px; cursor:pointer;">
                                ‚úî
                            </button>
                            <button onclick="markAttendance('${pass.user_id}', '${pass.id}', '${pass.package_name}', 'absent')" 
                                style="background:rgba(231, 76, 60, 0.2); color:#e74c3c; border:1px solid #e74c3c; border-radius:4px; cursor:pointer;">
                                ‚úñ
                            </button>
                             <button onclick="markAttendance('${pass.user_id}', '${pass.id}', '${pass.package_name}', 'excused')" 
                                style="background:rgba(241, 196, 15, 0.2); color:#f1c40f; border:1px solid #f1c40f; border-radius:4px; cursor:pointer;">
                                ‚ö†Ô∏è
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Expose function to window for button clicks
        window.markAttendance = async function (userId, passId, className, status) {
            if (!confirm(`Mark student as ${status.toUpperCase()}?`)) return;

            const { error } = await supabase
                .from('attendance_logs')
                .insert([{
                    user_id: userId,
                    pass_id: passId,
                    class_name: className,
                    status: status, // We need to add this column to DB or just use 'is_verified' logic? 
                    // For now let's assumes we add a 'status' column or repurpose.
                    // Actually, let's just save it. If column missing, it might error.
                    // Plan: Just save check_in_time. 'Absent'/Excused might need a new column or just a note.
                    check_in_time: new Date().toISOString(),
                    is_verified: true
                }]);

            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert(`Saved: ${status}`);
                // Optional: visual feedback on the button (disable it)
            }
        }

        function renderAllStudents(passes) {
            const tbody = document.getElementById('allTableBody');
            tbody.innerHTML = '';
            passes.forEach(pass => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pass.profiles?.first_name || 'Unknown'} ${pass.profiles?.last_name || ''}</td>
                    <td>${pass.package_name}</td>
                    <td><span class="status-badge status-${pass.status}">${pass.status}</span></td>
                 `;
                tbody.appendChild(row);
            });
        }

        function renderLiveLogs(logs) {
            const tbody = document.getElementById('liveTableBody');
            const countDisplay = document.getElementById('checkInCount');

            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No check-ins yet today.</td></tr>';
                countDisplay.textContent = '0';
                return;
            }

            // Filter logs for *today* for the counter
            const today = new Date().toISOString().split('T')[0];
            const todayLogs = logs.filter(l => l.check_in_time.startsWith(today));
            countDisplay.textContent = todayLogs.length;

            tbody.innerHTML = '';
            logs.forEach(log => {
                const time = new Date(log.check_in_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="color:var(--accent-light)">${time}</td>
                    <td>${log.profiles?.first_name} ${log.profiles?.last_name}</td>
                    <td>${log.class_name}</td>
                    <td><span class="status-badge status-active">Valid</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Tab Switching Logic
        window.switchTab = function (tabId) {
            document.querySelectorAll('.dashboard-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.admin-nav button').forEach(el => el.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Initialize
        checkAdmin();

    </script>
</body>

</html>